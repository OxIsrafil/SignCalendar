<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel ‚Äì Sign Scheduler</title>
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="logo">üîê Admin Panel</div>
  </nav>

  <section class="info-section">
    <div id="login-area">
      <h2>Admin Login</h2>
      <button id="loginBtn" class="btn">Log in with X or Email</button>
    </div>

    <div id="adminUI" style="display: none;">
      <h2>All Events (Moderation)</h2>
      <div id="eventsContainer"></div>
    </div>
  </section>

  <script>
    const allowedEmail = "israfil.m.pro@gmail.com";
    const allowedXHandle = "OxIsrafil";
    const nickname = (user.nickname || "").toLowerCase();

    let auth0;
    document.addEventListener("DOMContentLoaded", async () => {
      auth0 = await createAuth0Client({
        domain: "oxisrafil.jp.auth0.com",
        client_id: "YO4xCDLKrxQuscD7bH3ZBhn9UuWVuhTu",
        cacheLocation: "localstorage",
      });

      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        await auth0.handleRedirectCallback();
        window.history.replaceState({}, document.title, "/pages/admin.html");
      }

      const isAuthenticated = await auth0.isAuthenticated();
      if (!isAuthenticated) return;

      const user = await auth0.getUser();
      const email = user.email || "";
      const nickname = user.nickname?.toLowerCase() || "";

      const allowed = email === allowedEmail || nickname === allowedXHandle;
      if (!allowed) {
        document.getElementById("login-area").innerHTML = `<p style="color:red;">‚õî Access denied. Only @oxisrafil can view this page.</p>`;
        return;
      }

      document.getElementById("login-area").style.display = "none";
      document.getElementById("adminUI").style.display = "block";
      loadEvents();
    });

    document.getElementById("loginBtn").addEventListener("click", () => {
      auth0.loginWithRedirect({ redirect_uri: window.location.href });
    });

    async function loadEvents() {
      const res = await fetch("https://signcalendarbackend.onrender.com/api/events/all");
      const events = await res.json();

      const container = document.getElementById("eventsContainer");
      container.innerHTML = events.length
        ? events.map(ev => `
          <div class="event-card">
            <h3>${ev.title}</h3>
            <p>${ev.description}</p>
            <p><strong>Date:</strong> ${ev.date} | <strong>Time:</strong> ${ev.time}</p>
            <p><strong>Location:</strong> ${ev.location || "N/A"}</p>
            <p>Status: ${ev.approved ? "‚úÖ Approved" : "‚è≥ Pending"}</p>
            ${!ev.approved ? `
              <button onclick="approveEvent('${ev._id}')" class="btn">‚úÖ Approve</button>
              <button onclick="deleteEvent('${ev._id}')" class="btn" style="background:red;">‚ùå Reject</button>
            ` : ""}
          </div>
        `).join('')
        : "<p>No events yet.</p>";
    }

    async function approveEvent(id) {
      await fetch(`https://signcalendarbackend.onrender.com/api/events/${id}/approve`, { method: "PATCH" });
      loadEvents();
    }

    async function deleteEvent(id) {
      if (!confirm("Are you sure you want to reject and delete this event?")) return;
      await fetch(`https://signcalendarbackend.onrender.com/api/events/${id}`, { method: "DELETE" });
      loadEvents();
    }
  </script>
</body>
</html>
